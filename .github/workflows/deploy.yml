name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

# 2025 improvement: prevent overlapping deployments
concurrency:
  group: prod-deploy
  cancel-in-progress: true

jobs:
  deploy:
    name: Production Deployment
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      packages: write
      id-token: write  # For keyless image signing
    
    env:
      DEPLOY_USER: ${{ secrets.VPS_USER }}
      DEPLOY_HOST: ${{ secrets.VPS_HOST }}
    
    steps:
    - name: ğŸ“¦ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ğŸ” Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ” Install Cosign for Image Signing
      uses: sigstore/cosign-installer@v3

    - name: ğŸ—ï¸ Build and Push Web Image
      uses: docker/build-push-action@v6
      with:
        context: .
        file: Dockerfile
        target: prod
        push: true
        tags: ghcr.io/neolio42/whisnap-web:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          BUILDKIT_INLINE_CACHE=1
        
    - name: ğŸ” Sign Web Image
      run: cosign sign --yes ghcr.io/neolio42/whisnap-web:${{ github.sha }}

    - name: ğŸ›¡ï¸ Security Scan Web Image
      uses: aquasecurity/trivy-action@0.24.0
      with:
        image-ref: ghcr.io/neolio42/whisnap-web:${{ github.sha }}
        format: 'sarif'
        output: 'trivy-web-results.sarif'
        severity: 'CRITICAL,HIGH'
        exit-code: '0'  # Don't fail build on vulnerabilities
        
    - name: ğŸ—ï¸ Build and Push API Image
      uses: docker/build-push-action@v6
      with:
        context: .
        file: api/Dockerfile
        target: prod
        push: true
        tags: ghcr.io/neolio42/whisnap-api:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          BUILDKIT_INLINE_CACHE=1

    - name: ğŸ” Sign API Image
      run: cosign sign --yes ghcr.io/neolio42/whisnap-api:${{ github.sha }}
      
    - name: ğŸ”§ Configure SSH
      uses: shimataro/ssh-key-action@v2
      with:
        key: ${{ secrets.VPS_SSH_KEY }}
        known_hosts: ${{ secrets.VPS_KNOWN_HOSTS }}
        
    - name: ğŸš€ Sync Infrastructure Code
      run: |
        echo "ğŸ“¦ Syncing infrastructure code to production..."
        rsync -avz --delete \
          --exclude='.git' \
          --exclude='node_modules' \
          --exclude='.next' \
          --exclude='dist' \
          --exclude='coverage' \
          --exclude='docs' \
          --include='infra/' \
          --include='scripts/' \
          --include='infra/**' \
          --include='scripts/**' \
          --exclude='*' \
          . ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }}:/root/whisnap-deploy/
        echo "âœ… Infrastructure sync complete"

    - name: ğŸ” Setup Production Environment & SSL
      run: |
        ssh ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} << 'EOF'
        set -e
        
        echo "ğŸ” Creating production environment file..."
        install -m 600 /dev/null /root/whisnap-deploy/.env.prod
        cat > /root/whisnap-deploy/.env.prod << ENVEOF
        DATABASE_NAME=whisnap_prod
        DATABASE_USER=whisnap_prod_user
        DATABASE_PASSWORD=${{ secrets.DATABASE_PASSWORD }}
        DATABASE_PORT=5432
        ENCRYPTION_KEY=${{ secrets.ENCRYPTION_KEY }}
        JWT_SECRET=${{ secrets.JWT_SECRET }}
        NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
        NEXTAUTH_URL=https://whisnap.com
        GOOGLE_ID=${{ secrets.GOOGLE_ID }}
        GOOGLE_SECRET=${{ secrets.GOOGLE_SECRET }}
        STRIPE_PUBLIC_KEY=${{ secrets.STRIPE_PUBLIC_KEY }}
        STRIPE_SECRET_KEY=${{ secrets.STRIPE_SECRET_KEY }}
        STRIPE_WEBHOOK_SECRET=${{ secrets.STRIPE_WEBHOOK_SECRET }}
        RESEND_API_KEY=${{ secrets.RESEND_API_KEY }}
        EMAIL_SERVER=${{ secrets.EMAIL_SERVER }}
        OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
        ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}
        GOOGLE_AI_API_KEY=${{ secrets.GOOGLE_AI_API_KEY }}
        ASSEMBLYAI_API_KEY=${{ secrets.ASSEMBLYAI_API_KEY }}
        DEEPGRAM_API_KEY=${{ secrets.DEEPGRAM_API_KEY }}
        REV_AI_API_KEY=${{ secrets.REV_AI_API_KEY }}
        SENTRY_DSN=${{ secrets.SENTRY_DSN }}
        WEB_PORT=3000
        API_PORT=4000
        WS_PORT=4001
        REDIS_PORT=6379
        ENVEOF
        
        echo "ğŸ”’ Verifying SSL certificates..."
        if [ ! -f "/etc/letsencrypt/live/whisnap.com/fullchain.pem" ]; then
          echo "âŒ SSL certificate not found!"
          exit 1
        fi
        
        echo "ğŸ“ Moving to production directory..."
        rm -rf /root/whisnap || true
        mv /root/whisnap-deploy /root/whisnap
        
        # Secure the environment file
        chown root:root /root/whisnap/.env.prod
        chmod 600 /root/whisnap/.env.prod
        
        echo "âœ… Production environment setup complete"
        EOF

    - name: ğŸŒ Setup Blue-Green Network
      run: |
        ssh ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} << 'EOF'
        echo "ğŸŒ Creating external edge network..."
        docker network create edge 2>/dev/null || echo "âœ… Network 'edge' already exists"
        docker network create whisnap-network 2>/dev/null || echo "âœ… Network 'whisnap-network' already exists"
        
        echo "âœ… Blue-green network setup complete"
        EOF

    - name: ğŸš€ Execute Blue-Green Deployment
      run: |
        ssh ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} << 'EOF'
        set -e
        cd /root/whisnap
        
        echo "ğŸš€ Executing blue-green deployment..."
        chmod +x scripts/deploy-blue-green.sh
        export IMAGE_TAG=${{ github.sha }}
        export GHCR_READ_TOKEN=${{ secrets.GITHUB_TOKEN }}
        export GITHUB_ACTOR=${{ github.actor }}
        ./scripts/deploy-blue-green.sh production
        
        echo "âœ… Blue-green deployment complete"
        EOF

    - name: ğŸ” Production Health Check
      run: |
        ssh ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} << 'EOF'
        set -e
        
        echo "ğŸ” Performing comprehensive health checks..."
        
        # Check nginx configuration inside container
        docker exec nginx-proxy-nginx-1 nginx -t
        
        # Test HTTP endpoints through nginx container
        echo "ğŸŒ Testing HTTP access..."
        if docker exec nginx-proxy-nginx-1 curl -f --max-time 10 -H "Host: whisnap.com" http://localhost/ >/dev/null 2>&1; then
          echo "âœ… HTTP access working"
        else
          echo "âŒ HTTP access failed"
          exit 1
        fi
        
        # Test HTTPS endpoints through nginx container
        echo "ğŸ”’ Testing HTTPS access..."
        if docker exec nginx-proxy-nginx-1 curl -f --max-time 10 -k -H "Host: whisnap.com" https://localhost/ >/dev/null 2>&1; then
          echo "âœ… HTTPS access working"
        else
          echo "âŒ HTTPS access failed"
          exit 1
        fi
        
        # Test API endpoints through nginx container
        echo "ğŸ”Œ Testing API endpoints..."
        if docker exec nginx-proxy-nginx-1 curl -f --max-time 10 -H "Host: whisnap.com" http://localhost/api/v1/health >/dev/null 2>&1; then
          echo "âœ… API endpoints working"
        else
          echo "âŒ API endpoints failed"
          exit 1
        fi
        
        echo "ğŸ‰ All health checks passed!"
        echo "ğŸ“Š Active containers:"
        docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep -E "(web-|api-|whisnap)"
        EOF

    - name: ğŸ§¹ Cleanup
      if: success()
      run: |
        ssh ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} << 'EOF'
        echo "ğŸ§¹ Cleaning up unused Docker resources..."
        docker image prune -f
        docker container prune -f
        echo "âœ… Cleanup complete"
        EOF

    - name: ğŸ“Š Deployment Status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "ğŸ‰ Blue-Green Production deployment completed successfully!"
          echo "ğŸŒ Application available at: https://whisnap.com"
          echo "âœ¨ Zero-downtime deployment achieved"
        else
          echo "âŒ Production deployment failed!"
          exit 1
        fi