name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Production Deployment
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    env:
      DEPLOY_USER: ${{ secrets.VPS_USER }}
      DEPLOY_HOST: ${{ secrets.VPS_HOST }}
    
    steps:
    - name: 📦 Checkout Repository
      uses: actions/checkout@v4
      
    - name: 🔧 Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: 🔐 Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: 🏗️ Build and Push Web Image
      uses: docker/build-push-action@v6
      with:
        context: .
        file: Dockerfile
        push: true
        tags: ghcr.io/whisnap/whisnap-web:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: 🏗️ Build and Push API Image
      uses: docker/build-push-action@v6
      with:
        context: .
        file: api/Dockerfile
        push: true
        tags: ghcr.io/whisnap/whisnap-api:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
      
    - name: 🔧 Configure SSH
      uses: shimataro/ssh-key-action@v2
      with:
        key: ${{ secrets.VPS_SSH_KEY }}
        known_hosts: ${{ secrets.VPS_KNOWN_HOSTS }}
        
    - name: 🚀 Sync Infrastructure Code
      run: |
        echo "📦 Syncing infrastructure code to production..."
        rsync -avz --delete \
          --exclude='.git' \
          --exclude='node_modules' \
          --exclude='.next' \
          --exclude='dist' \
          --exclude='coverage' \
          --exclude='docs' \
          --exclude='Dockerfile*' \
          --exclude='api/Dockerfile*' \
          infra/ scripts/ ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }}:/root/whisnap-deploy/
        echo "✅ Infrastructure sync complete"

    - name: 🔐 Setup Production Environment & SSL
      run: |
        ssh ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} << 'EOF'
        set -e
        
        echo "🔐 Creating production environment file..."
        install -m 600 /dev/null /root/whisnap-deploy/.env.prod
        cat > /root/whisnap-deploy/.env.prod << ENVEOF
        DATABASE_NAME=whisnap_prod
        DATABASE_USER=whisnap_prod_user
        DATABASE_PASSWORD=${{ secrets.DATABASE_PASSWORD }}
        DATABASE_PORT=5432
        ENCRYPTION_KEY=${{ secrets.ENCRYPTION_KEY }}
        JWT_SECRET=${{ secrets.JWT_SECRET }}
        NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
        NEXTAUTH_URL=https://whisnap.com
        GOOGLE_ID=${{ secrets.GOOGLE_ID }}
        GOOGLE_SECRET=${{ secrets.GOOGLE_SECRET }}
        STRIPE_PUBLIC_KEY=${{ secrets.STRIPE_PUBLIC_KEY }}
        STRIPE_SECRET_KEY=${{ secrets.STRIPE_SECRET_KEY }}
        STRIPE_WEBHOOK_SECRET=${{ secrets.STRIPE_WEBHOOK_SECRET }}
        RESEND_API_KEY=${{ secrets.RESEND_API_KEY }}
        EMAIL_SERVER=${{ secrets.EMAIL_SERVER }}
        OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
        ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}
        GOOGLE_AI_API_KEY=${{ secrets.GOOGLE_AI_API_KEY }}
        ASSEMBLYAI_API_KEY=${{ secrets.ASSEMBLYAI_API_KEY }}
        DEEPGRAM_API_KEY=${{ secrets.DEEPGRAM_API_KEY }}
        REV_AI_API_KEY=${{ secrets.REV_AI_API_KEY }}
        SENTRY_DSN=${{ secrets.SENTRY_DSN }}
        WEB_PORT=3000
        API_PORT=4000
        WS_PORT=4001
        REDIS_PORT=6379
        ENVEOF
        
        echo "🔒 Verifying SSL certificates..."
        if [ ! -f "/etc/letsencrypt/live/whisnap.com/fullchain.pem" ]; then
          echo "❌ SSL certificate not found!"
          exit 1
        fi
        
        echo "📁 Moving to production directory..."
        rm -rf /root/whisnap-prod || true
        mv /root/whisnap-deploy /root/whisnap-prod
        
        # Secure the environment file
        chown root:root /root/whisnap-prod/.env.prod
        chmod 600 /root/whisnap-prod/.env.prod
        
        echo "✅ Production environment setup complete"
        EOF

    - name: 🌐 Setup Blue-Green Network
      run: |
        ssh ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} << 'EOF'
        echo "🌐 Creating external edge network..."
        docker network create edge 2>/dev/null || echo "✅ Network 'edge' already exists"
        
        echo "🔧 Setting up nginx upstreams directory..."
        sudo mkdir -p /etc/nginx/upstreams
        
        # Copy upstream files if they don't exist
        if [ ! -f "/etc/nginx/upstreams/blue.conf" ]; then
          sudo cp /root/whisnap-prod/infra/nginx/upstreams/blue.conf /etc/nginx/upstreams/
        fi
        if [ ! -f "/etc/nginx/upstreams/green.conf" ]; then
          sudo cp /root/whisnap-prod/infra/nginx/upstreams/green.conf /etc/nginx/upstreams/
        fi
        
        # Set initial current.conf if it doesn't exist (don't test nginx yet)
        if [ ! -L "/etc/nginx/upstreams/current.conf" ] && [ ! -f "/etc/nginx/upstreams/current.conf" ]; then
          sudo ln -sf /etc/nginx/upstreams/blue.conf /etc/nginx/upstreams/current.conf
        fi
        
        echo "✅ Blue-green network setup complete"
        EOF

    - name: 🚀 Execute Blue-Green Deployment
      run: |
        ssh ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} << 'EOF'
        set -e
        cd /root/whisnap-prod
        
        echo "🚀 Executing blue-green deployment..."
        chmod +x deploy-blue-green.sh
        export IMAGE_TAG=${{ github.sha }}
        export GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}
        export GITHUB_ACTOR=${{ github.actor }}
        ./deploy-blue-green.sh production
        
        echo "✅ Blue-green deployment complete"
        EOF

    - name: 🔍 Production Health Check
      run: |
        ssh ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} << 'EOF'
        set -e
        
        echo "🔍 Performing comprehensive health checks..."
        
        # Check nginx configuration inside container
        docker exec nginx nginx -t
        
        # Test HTTP endpoints through nginx container
        echo "🌐 Testing HTTP access..."
        if docker exec nginx curl -f --max-time 10 -H "Host: whisnap.com" http://localhost/ >/dev/null 2>&1; then
          echo "✅ HTTP access working"
        else
          echo "❌ HTTP access failed"
          exit 1
        fi
        
        # Test HTTPS endpoints through nginx container
        echo "🔒 Testing HTTPS access..."
        if docker exec nginx curl -f --max-time 10 -k -H "Host: whisnap.com" https://localhost/ >/dev/null 2>&1; then
          echo "✅ HTTPS access working"
        else
          echo "❌ HTTPS access failed"
          exit 1
        fi
        
        # Test API endpoints through nginx container
        echo "🔌 Testing API endpoints..."
        if docker exec nginx curl -f --max-time 10 -H "Host: whisnap.com" http://localhost/api/v1/health >/dev/null 2>&1; then
          echo "✅ API endpoints working"
        else
          echo "❌ API endpoints failed"
          exit 1
        fi
        
        echo "🎉 All health checks passed!"
        echo "📊 Active containers:"
        docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep -E "(web-|api-|whisnap)"
        EOF

    - name: 🧹 Cleanup
      if: success()
      run: |
        ssh ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} << 'EOF'
        echo "🧹 Cleaning up unused Docker resources..."
        docker image prune -f
        docker container prune -f
        echo "✅ Cleanup complete"
        EOF

    - name: 📊 Deployment Status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "🎉 Blue-Green Production deployment completed successfully!"
          echo "🌐 Application available at: https://whisnap.com"
          echo "✨ Zero-downtime deployment achieved"
        else
          echo "❌ Production deployment failed!"
          exit 1
        fi